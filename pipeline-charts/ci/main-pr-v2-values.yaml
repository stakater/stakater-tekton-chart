name: stakater-main-pr-v2
workspaces:
  - name: source
    volumeClaimTemplate:
      accessModes: ReadWriteOnce
      resourcesRequestsStorage: 1Gi
pipelines:
  finally:
    - taskName: stakater-set-commit-status-v1
      name: set-commit-status-task-result
  tasks:
    - taskName: stakater-set-commit-status-v1
      params:
      - name: state
        value: pending
    - taskName: git-clone
    - taskName: stakater-create-git-tag-v1
    - taskName: stakater-unit-test-v1
    - taskName: stakater-sonarqube-scanner-v1
    - taskName: stakater-buildah-v1
      runAfter:
      - stakater-unit-test-v1
    - taskName: stakater-trivy-scan-v1
      runAfter:
      - stakater-buildah-v1
    - taskName: rox-image-scan
      runAfter:
      - stakater-buildah-v1
    - taskName: rox-image-check
      runAfter:
      - stakater-buildah-v1
    - taskName: rox-deployment-check
      runAfter:
      - stakater-buildah-v1
    - taskName: stakater-checkov-scan-v1
      runAfter:
      - stakater-trivy-scan-v1
      - rox-image-scan
      - rox-image-check
      - rox-deployment-check
    - taskName: stakater-comment-on-github-pr-v1
    - taskName: stakater-helm-push-v1
    - taskName: stakater-create-environment-v1
    - taskName: stakater-update-cd-repo-v3
    - taskName: stakater-push-main-tag-v1
triggertemplate:
  serviceAccountName: stakater-tekton-builder
eventlistener:
  serviceAccountName: stakater-tekton-builder
  triggers:
  - name : stakater-pr-cleaner-v2-pullrequest-merge
    create: false
  - name: pullrequest
    bindings:
    - ref: stakater-pr-v1    
  - name: push
    bindings:
    - ref: stakater-main-v1