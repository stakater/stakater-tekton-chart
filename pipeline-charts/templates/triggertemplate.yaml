{{ if .Values.triggertemplate.enabled }}
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerTemplate
metadata:
  name: {{ include "pipeline-charts.name" . }}
  namespace: {{ .Release.Namespace }}
spec:
  {{- if or .Values.pipelines.params .Values.triggertemplate.additionalParams }}
  params:
    {{- range .Values.pipelines.params }}
    - name: {{ .name }}   
      {{- if .description }}
      description: {{ .description }} 
      {{- end }}
      {{- if .default }}
      default: {{ .default }} 
      {{- end }}
    {{- end }}
    {{- range .Values.triggertemplate.additionalParams }}
    - name: {{ .name }}   
      {{- if .description }}
      description: {{ .description }} 
      {{- end }}
      {{- if .default }}
      default: {{ .default }} 
      {{- end }}
    {{- end }}
  {{- end }}
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        {{- if .Values.triggertemplate.pipelineRunNamePrefix }}
        generateName: {{ .Values.triggertemplate.pipelineRunNamePrefix }}-
        {{- else }}
        generateName: {{ include "pipeline-charts.name" . }}-
        {{- end }}
        namespace: {{ .Release.Namespace }}
        {{- if .Values.triggertemplate.pipelineRunAnnotations }}
        annotations:
          {{- toYaml .Values.triggertemplate.pipelineRunAnnotations | nindent 10 }}
        {{- end }}
      spec:
        {{- if .Values.triggertemplate.serviceAccountName }}
        serviceAccountName: {{ .Values.triggertemplate.serviceAccountName }}
        {{- end }}
        {{- if .Values.pipelines.params }}
        params:
          {{- range .Values.pipelines.params }}
          - name: {{ .name }}
            value: $(tt.params.{{.name}})  
          {{- end }}
        {{- end }}
        pipelineRef:
          name: {{ include "pipeline-charts.name" . }}
        {{- if .Values.triggertemplate.workspaces }}
        workspaces:
          {{- range .Values.triggertemplate.workspaces -}}
          {{- if eq .type "volumeClaimTemplate"}}
          - name: {{ .name }}
            {{- if and .accessModes .resourcesRequestsStorage }}
            volumeClaimTemplate:
              spec:
                accessModes:
                - {{ .accessModes }}
                resources:
                  requests:
                    storage: {{ .resourcesRequestsStorage }}
            {{- end -}}
          {{- end -}}
          {{- if eq .type "persistentvolumeclaim" }}
          - name: {{ .name }}
            {{- if .claimName }}
            persistentVolumeClaim:
              claimName: {{ .claimName }}
            {{- end -}}
            {{- if .subPath }}
            subPath: {{ .subPath }}
            {{- end }}
          {{- end }}
          {{- if eq .type "emptydir" }}
          - name: {{ .name }}
            emptyDir: {}
          {{- end -}}
          {{- if eq .type "configmap" }}
          - name: {{ .name }}
            {{ if .configMapName }}
            configmap:
              name: {{ .configMapName }}
            {{- end }}
          {{- end }}
          {{- end }}
        {{- end }}
{{- end }}